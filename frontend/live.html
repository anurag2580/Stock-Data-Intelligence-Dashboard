<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        /* GLOBAL STYLES */
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f4f6f8; color: #333; }
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #e1e4e8; display: flex; flex-direction: column; z-index: 10; }
        .search-container { padding: 20px; border-bottom: 1px solid #eee; background: #fff; }
        #searchInput { width: 90%; padding: 10px; border: 1px solid #dfe1e5; border-radius: 6px; outline: none; background: #f8f9fa; }
        
        .view-toggle-box { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: 600; color: #555; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00d09c; }
        input:checked + .slider:before { transform: translateX(16px); }

        #list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        #list li { padding: 12px 20px; border-bottom: 1px solid #f1f1f1; cursor: pointer; color: #444; font-weight: 500; }
        #list li:hover { background: #f0fdf9; color: #00d09c; padding-left: 25px; }
        #list li.active { background: #e6f7f3; color: #00d09c; border-right: 3px solid #00d09c; }

        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; justify-content: center; align-items: center; z-index: 50; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #00d09c; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CARDS - NOW 4 COLUMNS */
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card h2 { margin: 8px 0 0 0; color: #222; font-size: 22px; }
        .card small { color: #888; font-size: 11px; text-transform: uppercase; font-weight: 600; }
        
        .card.return-card { border-bottom: 4px solid #2962FF; } /* Blue for Returns */
        .card.price-card { border-bottom: 4px solid #222; }
        .card.vol-card { border-bottom: 4px solid #ffc107; }
        .card.ai-card { border-bottom: 4px solid #00d09c; }

        .compare-section { background: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .compare-inputs { display: flex; gap: 10px; flex: 1; }
        .compare-inputs input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase; outline: none; }
        .compare-btn { background: #2c3e50; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-item { background: #fff; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #eee; color: #666; font-size: 13px; }
        .stat-item span { font-weight: 700; display: block; margin-top: 4px; font-size: 15px; color: #333; }

        .content-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; min-height: 480px; }
        #chartBox { height: 420px; width: 100%; }
        .chart-controls { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .time-btn { background: #fff; border: 1px solid #e1e4e8; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #555; }
        .time-btn.active { background: #e6f7f3; color: #00d09c; border-color: #00d09c; }
        #chartTypeSelector { padding: 6px 12px; border-radius: 6px; border: 1px solid #e1e4e8; background: #fff; cursor: pointer; outline: none; font-weight: 600; color: #555; margin-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; text-align: right; padding: 12px 15px; border-bottom: 2px solid #eee; color: #666; }
        td { border-bottom: 1px solid #eee; padding: 12px 15px; text-align: right; color: #333; }
        th:first-child, td:first-child { text-align: left; }
        .blur-value { filter: blur(4px); cursor: pointer; transition: filter 0.2s; opacity: 0.6; }
        .blur-value:hover { filter: blur(0); opacity: 1; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="search-container">
            <h3>üìà MarketWatch</h3>
            <input type="text" id="searchInput" placeholder="Search (e.g. TATA)..." onkeyup="handleSearchKey(event)">
        </div>
        <div class="view-toggle-box">
            <span>üìä Chart</span>
            <label class="switch"><input type="checkbox" id="viewToggle" onchange="toggleView()"><span class="slider round"></span></label>
            <span>üìã Table</span>
        </div>
        <ul id="list"><li style="text-align:center; padding:20px; color:#999;">Loading List...</li></ul>
    </div>

    <div class="main">
        <div id="loadingOverlay"><div class="spinner"></div></div>

        <div id="dashboardContent">
            <div style="margin-bottom: 20px;">
                <h1 id="title" style="margin:0; font-size:28px; color:#1a1a1a;">Select a Company</h1>
                <span style="color:#888; font-size:13px;">Real-time market analytics & AI forecasts</span>
            </div>
            
            <div class="cards">
                <div class="card return-card">
                    <small id="returnLabel">1M Return</small>
                    <h2 id="periodReturn">-</h2>
                </div>

                <div class="card price-card"><small>Current Price</small><h2 id="price">-</h2></div>
                <div class="card vol-card"><small>Volatility Risk</small><h2 id="volatility">-</h2></div>
                <div class="card ai-card"><small>AI Prediction (Next Day)</small><h2 id="ai">-</h2></div>
            </div>

            <div class="compare-section">
                <div class="compare-label" style="font-weight:700; color:#555;">‚öîÔ∏è Compare</div>
                <div class="compare-inputs">
                    <input type="text" id="comp1" placeholder="Sym 1">
                    <span style="align-self:center; font-weight:bold; color:#ccc;">VS</span>
                    <input type="text" id="comp2" placeholder="Sym 2">
                </div>
                <button class="compare-btn" onclick="compareStocks()">Go</button>
            </div>

            <div class="stats-grid">
                <div class="stat-item">52-Week High <span id="high52">-</span></div>
                <div class="stat-item">52-Week Low <span id="low52">-</span></div>
                <div class="stat-item">Daily Return <span id="dailyReturn">-</span></div>
            </div>

            <div id="chartSection" class="content-section">
                <div id="chartBox"></div> 
                <div class="chart-controls">
                    <button class="time-btn" onclick="updateChart('1D', this)">1D</button>
                    <button class="time-btn active" onclick="updateChart('1M', this)">1M</button>
                    <button class="time-btn" onclick="updateChart('1W', this)">1W</button>
                    <button class="time-btn" onclick="updateChart('6M', this)">6M</button>
                    <button class="time-btn" onclick="updateChart('1Y', this)">1Y</button>
                    <button class="time-btn" onclick="updateChart('5Y', this)">5Y</button>
                    <button class="time-btn" onclick="updateChart('MAX', this)">Max</button>
                    <span style="border-left: 1px solid #ddd; height: 16px; margin: 0 10px;"></span>
                    <select id="chartTypeSelector" onchange="changeChartType()">
                        <option value="area">üìà Line</option>
                        <option value="candlestick">üïØÔ∏è Candles</option>
                    </select>
                </div>
            </div>

            <div id="tableSection" class="content-section" style="display: none;">
                <div style="overflow-x: auto; max-height: 480px;">
                    <table id="historyTable">
                        <thead><tr><th>Date</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th><th>Value (Cr)</th><th>Return</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://127.0.0.1:8000";
        let currentSymbol = ""; 
        let currentRange = "1M";
        let chartInstance = null; 
        let cachedReturns = {}; // Store returns to update UI instantly

        function toggleView() {
            const isChecked = document.getElementById("viewToggle").checked;
            document.getElementById("chartSection").style.display = isChecked ? "none" : "block";
            document.getElementById("tableSection").style.display = isChecked ? "block" : "none";
        }

        async function load() {
            try {
                const res = await fetch(API + "/companies");
                const companies = await res.json();
                const list = document.getElementById("list");
                list.innerHTML = "";
                companies.forEach(c => {
                    const li = document.createElement("li");
                    li.innerText = c.symbol;
                    li.onclick = () => {
                        document.querySelectorAll("#list li").forEach(el => el.classList.remove("active"));
                        li.classList.add("active");
                        show(c.symbol);
                    };
                    list.appendChild(li);
                });
            } catch (e) { console.error(e); }
        }

        function handleSearchKey(event) {
            const filter = document.getElementById("searchInput").value.toUpperCase();
            const li = document.getElementById("list").getElementsByTagName("li");
            for (let i = 0; i < li.length; i++) {
                li[i].style.display = li[i].innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
            if (event.key === "Enter") {
                const visible = document.querySelector("#list li:not([style*='display: none'])");
                if (visible) visible.click();
            }
        }

        async function show(symbol) {
            currentSymbol = symbol;
            const loader = document.getElementById("loadingOverlay");
            loader.style.visibility = "visible"; loader.style.opacity = "1";

            try {
                const [summaryRes, aiRes] = await Promise.all([
                    fetch(`${API}/summary/${symbol}`),
                    fetch(`${API}/predict/${symbol}`)
                ]);
                
                if (!summaryRes.ok) throw new Error("Fetch failed");
                const summary = await summaryRes.json();
                const ai = await aiRes.json();

                // STORE RETURNS GLOBALLY
                cachedReturns = summary.returns; 

                document.getElementById("title").innerText = summary.symbol;
                document.getElementById("price").innerText = "‚Çπ" + summary.current_price;
                
                // Update Volatility Card
                const volCard = document.getElementById("volatility");
                volCard.innerHTML = `<div style="color:${summary.risk_color}; font-size:20px; font-weight:bold;">${summary.risk_label}</div><div style="font-size:11px; color:#888;">Score: ${summary.volatility}</div>`;
                
                // Update Returns Card (Default to 1M)
                updateReturnCard("1M");

                const aiCard = document.getElementById("ai");
                if(ai.random_forest) {
                    aiCard.innerHTML = `<div style="font-size:20px; font-weight:bold;">‚Çπ${ai.random_forest}</div><div style="font-size:11px; color:#888; font-weight:normal;">Linear Model: ‚Çπ${ai.linear}</div>`;
                } else { aiCard.innerText = "‚Çπ" + ai.prediction; }

                document.getElementById("high52").innerText = "‚Çπ" + summary.high_52;
                document.getElementById("low52").innerText = "‚Çπ" + (summary.low_52 || "-");
                
                const dRet = document.getElementById("dailyReturn");
                dRet.innerText = (summary.returns["1D"] || 0) + "%"; // Use 1D return if available or calc manually
                
                document.getElementById("comp1").value = symbol;

                await Promise.all([renderApexChart(symbol, currentRange), loadTable(symbol, currentRange)]);
            } catch(e) { 
                console.error(e);
            } finally {
                loader.style.opacity = "0";
                setTimeout(() => loader.style.visibility = "hidden", 250);
            }
        }

        // --- NEW HELPER: Updates Return Card based on Range ---
       // --- UPDATED HELPER: Shows % and ‚Çπ ---
        function updateReturnCard(range) {
            if (!cachedReturns) return;
            
            // Get data for the selected range
            let data = cachedReturns[range];
            
            // Fallback for missing data
            if (!data) {
                // Try to fallback to 1W if a specific range is missing
                data = cachedReturns['1W'] || { percent: 0, value: 0 }; 
            }
            
            const label = document.getElementById("returnLabel");
            const valueElem = document.getElementById("periodReturn");
            
            label.innerText = `${range} Return`;
            
            const pct = data.percent;
            const val = data.value;
            
            // Format: +5.20% (+‚Çπ120.50)
            const sign = pct >= 0 ? "+" : "";
            const color = pct >= 0 ? "#00d09c" : "#ff4444"; // Green or Red
            
            valueElem.innerHTML = `
                <span style="color:${color}">${sign}${pct.toFixed(2)}%</span>
                <span style="font-size:14px; color:#888; font-weight:normal; margin-left:5px;">
                    (${sign}‚Çπ${val.toFixed(2)})
                </span>
            `;
        }

        async function renderApexChart(symbol, range) {
            try {
                let seriesData = [];
                let rawData = [];
                let isIntraday = (range === '1D'); 

                if (isIntraday) {
                    const res = await fetch(`${API}/live-data/${symbol}`);
                    const liveData = await res.json();
                    seriesData = liveData.labels.map((time, i) => ({ x: time, y: liveData.prices[i] }));
                } else {
                    const res = await fetch(`${API}/chart-data/${symbol}?time_range=${range}`);
                    rawData = await res.json();
                    if (!rawData || rawData.length === 0) return;
                    
                    const chartType = document.getElementById("chartTypeSelector").value;
                    if (chartType === 'candlestick') {
                        seriesData = rawData.map(d => ({ x: d.x, y: d.y }));
                    } else {
                        seriesData = rawData.map(d => ({ x: d.x, y: d.y[3] }));
                    }
                }

                if (chartInstance) { chartInstance.destroy(); }

                const startPrice = isIntraday ? seriesData[0].y : (seriesData[0].y.length ? seriesData[0].y[3] : seriesData[0].y);
                const endPrice = isIntraday ? seriesData[seriesData.length-1].y : (seriesData[seriesData.length-1].y.length ? seriesData[seriesData.length-1].y[3] : seriesData[seriesData.length-1].y);
                const chartColor = endPrice >= startPrice ? '#00d09c' : '#ff4444'; 

                let tickCount = 8;
                if (range === '1D' || range === '1W' || range === '1M') tickCount = 15;

                const options = {
                    series: [{ name: symbol, data: seriesData }],
                    chart: { 
                        type: isIntraday ? 'area' : document.getElementById("chartTypeSelector").value,
                        height: 420, 
                        fontFamily: 'Segoe UI, sans-serif',
                        toolbar: { show: true, tools: { download: false } },
                        animations: { enabled: true }
                    },
                    colors: [chartColor],
                    title: { text: undefined },
                    xaxis: { 
                        type: 'category', 
                        tickAmount: tickCount,
                        labels: { 
                            rotate: -45, 
                            style: { fontSize: '11px', colors: '#888' },
                            formatter: function(val) {
                                if (isIntraday) return val; 
                                if (!val) return "";
                                const d = new Date(val);
                                if (isNaN(d.getTime())) return val;
                                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + " '" + d.getFullYear().toString().substr(-2);
                            }
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: { 
                        opposite: true, 
                        labels: { formatter: (val) => val.toFixed(2), style: { colors: '#888' } },
                        tooltip: { enabled: true }
                    },
                    grid: { borderColor: '#f1f1f1', strokeDashArray: 4 },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.05, stops: [0, 100] } },
                    plotOptions: { candlestick: { colors: { upward: '#00d09c', downward: '#ff4444' } } },
                    dataLabels: { enabled: false },
                    tooltip: { y: { formatter: (val) => "‚Çπ" + val.toFixed(2) } }
                };

                chartInstance = new ApexCharts(document.querySelector("#chartBox"), options);
                chartInstance.render();
            } catch (err) { console.error("Chart Error", err); }
        }

        function changeChartType() {
            if (currentSymbol) renderApexChart(currentSymbol, currentRange);
        }

        async function loadTable(symbol, range) {
            if (range === '1D') return;
            const tbody = document.getElementById("tableBody");
            try {
                const res = await fetch(`${API}/data/${symbol}?time_range=${range}`);
                const data = await res.json();
                tbody.innerHTML = "";
                data.slice().reverse().forEach(row => {
                    const tr = document.createElement("tr");
                    const retVal = row.Daily_Return * 100;
                    const turnover = (parseFloat(row.Close) * parseInt(row.Volume)) / 10000000;
                    tr.innerHTML = `
                        <td>${row.Date}</td>
                        <td>${parseFloat(row.Open).toFixed(2)}</td>
                        <td>${parseFloat(row.High).toFixed(2)}</td>
                        <td>${parseFloat(row.Low).toFixed(2)}</td>
                        <td><strong>${parseFloat(row.Close).toFixed(2)}</strong></td>
                        <td>${parseInt(row.Volume).toLocaleString()}</td>
                        <td><span class="blur-value" title="Show">‚Çπ${turnover.toFixed(2)} Cr</span></td>
                        <td style="color:${retVal >= 0 ? '#00d09c':'#ff4444'}; font-weight:600;">${retVal.toFixed(2)}%</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function updateChart(range, btn) {
            if (!currentSymbol) return;
            currentRange = range;
            
            // UPDATE THE BUTTONS
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // UPDATE THE RETURNS CARD
            updateReturnCard(range);

            document.getElementById("chartBox").style.opacity = "0.5";
            if (range === '1D') {
                await renderApexChart(currentSymbol, range);
            } else {
                await Promise.all([renderApexChart(currentSymbol, range), loadTable(currentSymbol, range)]);
            }
            document.getElementById("chartBox").style.opacity = "1";
        }

        async function compareStocks() {
            const s1 = document.getElementById('comp1').value.toUpperCase();
            const s2 = document.getElementById('comp2').value.toUpperCase();
            if(!s1 || !s2) return alert("Enter two symbols!");
            try {
                const res = await fetch(`${API}/compare?symbol1=${s1}&symbol2=${s2}`);
                const data = await res.json();
                alert(`üèÜ WINNER: ${data.winner}\n\n${s1}: ${data.comparison[s1].average_return_30d}%\n${s2}: ${data.comparison[s2].average_return_30d}%`);
            } catch (e) { alert("Comparison failed."); }
        }

        load();
    </script>
</body>
</html>